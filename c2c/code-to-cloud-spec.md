# Ballerina Code to Cloud Specification

## Introduction

The main objective of this specification is to simplify the developer experience of developing and deploying
 ballerina code in the cloud. C2C enables developers who have no in-depth knowledge about cloud native
  technologies to concentrate on writing the code and deploying the code on cloud with no additional configuration.
   Cloud orchestration systems such as Kubernetes require developers to have extensive knowledge about the technology in order to be able to deploy their code. 
   The Code2Cloud functionality built into Ballerina would allow the developers to generate the deployment artifacts necessary for deploying their code in these platforms with minimal configurations.

## Project Structure

The deployment artifacts will be generated in the target directory of the project depending on the provider selected.

``` 
.
├── Ballerina.cloud                               <- Used to override default configurations used to generate artifacts.
├── Ballerina.lock
├── Ballerina.toml
├── src
│   └── module
│       └── entry.bal                             <- Entry point of the project.
└── target
    ├── balo
    │   └── module-0.0.1.balo
    ├── bin
    │   └── module.jar
    ├── caches
    │   ├── bir_cache\
    │   └── jar_cache\
    |
    ├── docker
    │   └── module
    │       └── Dockerfile                        <- Generated Dockerfile according to the ballerina project
    └── kubernetes
        └── module
            └── c2c-sample-module-0.0.1.yaml      <- Generated Kuberenetes deployment YAML artifact for the ballerina project

```

#### Ballerina.toml

Contains metadata about the ballerina project. This file is used to fetch defaults for deployment artifacts generation.

#### entry.bal

Represents any .bal file that has an entry point. Compiler will be using the file to retrieve service related
 information for the deployment artifacts.

#### Ballerina.cloud

An optional configuration file used to override the default values generated by C2C. 

#### target/docker/

Contains the Docker artifacts generated from C2C. These artifacts will be required to build the Docker image.

#### target/kubernetes/

Contains the Kubernetes artifacts generated from C2C. These artifacts will be required to deploy the ballerina
 application in kubernetes.

## Building Cloud Artifacts

Ballerina recommends having single entry point per ballerina project. The cloud artifacts will be generated per
 project. Therefore, these artifacts can be built executing following command in the ballerina project directory.
 
 For Docker
  

``` sh
  $ ballerina build -a --cloud=docker
  ```

 For Kubernetes
 

``` sh
 $ ballerina build -a --cloud=k8s
 ```

## Features

### Container Creation

#### Basic Container Creation

C2C enables developers to create containers using the ballerina code without any additional configuration. 

``` yaml
[container.image]
repository="wso2"
name="sample-c2c" 
tag="v0.1.1" 
base="openjdk:slim"
    [container.image.user]
    run_as=ballerina
```

#### Exposing Services

C2C supports exposing containers via listeners. It also allows developers to set the internal domain and external
 accessibility.

``` ballerina
import ballerina/http;

service hello on new http:Listener(9090) {

    resource function sayHello(http:Caller caller,http:Request req) returns error? {
        check caller->respond("Hello, World!");
    }
}

service echo on new http:Listener(9091) {

    resource function foo(http:Caller caller, http:Request req) returns error? {
        check caller->respond("Foo ");
    }
}

```

``` yaml
[cloud.deployment]
internal_domain_name="myfoo" 
external_accessible=true  
```

#### Resource Limits and Autoscaling

Enabling Resource limits prevents containers from crashing and ensures healthy containers. C2C generates artifacts
 required for the orchestrator to limit the resource taken from one
 container. It also generates autoscaling artifacts to smoothly scale when containers as overloaded.

``` yaml
[cloud.deployment]
min_memory="100Mi" 
max_memory="256Mi" 
min_cpu="1000m" 
max_cpu="1500m" 

[cloud.deployment.autoscaling]
min_replicas=2
max_replicas=5
cpu=50
memory=80
```

### Configuration 

Ballerina Code to Cloud provides ability for developers to provide configurations in the Ballerina.cloud also to
 refer to external configuration files.
 
 #### Inline Configuration

``` yaml
[[cloud.config.envs]]
config_name= "module-foo"
key= "FOO"

[[cloud.config.envs]]
name= "bar"
config_name= "module-bar"
key= "BAR"
```

#### External Configuration

``` yaml
[[cloud.config.files]]
    file="resource/ballerina.conf"
    mount_path="/home/ballerina/foo/ballerina.conf"
[[cloud.config.files]]
    file"application1.properties"
    mount_path="/home/ballerina/foo/app1.properties"
```

### Cronjobs

When the developer wants to execute a task periodically, the most optimum way is to let the orchestrator handle the
 scheduling and execution rather than having a process running continuously. The following behavior can be achieved
  using Task annotation in ballerina/c2c library.

``` ballerina
import ballerina/io;
import ballerina/c2c;

@c2c:Task {
  schedule: {
     seconds: "0/2",
     minutes: "*",
     hours: "*",
     daysOfMonth: "?",
     months: "*",
     daysOfWeek: "*",
     year: "*"
  }
}

function hello() {
   io:println(“Hello”);
}
```

### Probes

Container orchestrators uses probes as a way of ensuring the readiness and health of the container. Ballerina Code to
 Cloud makes it easier for the developers to define probes.

``` yaml
[cloud.deployment.probes.readiness]
port=9091
path=”/readyz“

[cloud.deployment.probes.liveness]
port=9091
path=”/healthz” 
```

## Ballerina.cloud Properties

Ballerina Code to Cloud supports number of properties that is required to deploy the code in the cloud. All of these
 properties contains suitable default values derived from the code. These values can be overridden using the optional
  Ballerina.cloud file. Ballerina.cloud file follows TOML Specification.

#### [container.image]

Contains container image related properties.

|Identifier   	|Description	                            |Default Value   	|
|---	        |---	                                    |---	            |
|name   	    |Name of the container image                |$PROJECT_NAME   	|
|repository   	|Container repository to host the container |"local"   	        |
|tag   	        |Tag of the container   	                |"latest"   	    |
|base   	    |Base container of the container image   	|"openjdk:slim"   	|

    

#### [container.image.user]

Container image user account related properties

|Identifier   	|Description	                |Default Value   	|
|---	        |---	                        |---	            |
|run_as   	    |Name of the container image   	|"ballerina"   	    |

#### [[cloud.config.envs]]

Contains the configs required for the application in terms of Key Value pairs.

|Identifier     |Description	                                        |Example Value  |
|---	        |---	                                                |---	        |
|key_ref   	    |Key of the environment variable                        |"FOO"   	    |
|name(optional) |Name of the env if its different from the Key          |"foo"   	    | 
|config_name    |Name of the config config map                          |"module-foo"   |

#### [[cloud.config.secrets]]

Contains external configuration files for the code.

|Identifier   	|Description	                                        |Example Value   	    |
|---	        |---	                                                |---	                |
|key_ref   	    |Reference key of the secret                            |"MYSQL_ROOT_PASSWORD"  |
|name(optional) |Name of the secret if its different from the Key	    |"ROOT_PASSWORD"  	    |
|secret_name   	|Name of the secret group                               |"db-crdential-secret"  |

#### [[cloud.config.files]]

Contains external configuration files for the code.

|Identifier |Description	                                    |Default Value   	                  |
|---	    |---	                                            |---	                              |
|file   	|Path of the external configuration file  	        |"resource/ballerina.conf"  	      |
|mount_path |Path of the configuration file in the container   	|"/home/ballerina/foo/ballerina.conf" |

#### [cloud.deployment]

Contains the properties related to the deployment.

|Identifier   	        |Description	                                         |Default Value   	|
|---	                |---	                                                 |---	            |
|internal_domain_name   |Name of the internal domain  	                         |$PROJECT_NAME  	|
|external_accessible   	|Status of exposing the container outside of the cluster |true   	        |
|min_memory   	        |Minimum memory allocated to the container   	         |"100Mi"   	    |
|max_memory   	        |Maximum memory allocated to the container  	         |"256Mi"   	    |
|min_cpu   	            |Minimum CPU allocated to the container 	             |"1000m"   	    |
|max_cpu   	            |Maximum CPU allocated to the container  	             |"1500m"   	    |

#### [cloud.deployment.autoscaling]

Contains the matrices to auto scale the container

|Identifier     |Description	                                                    |Default Value |
|---	        |---	                                                            |---	       |
|enable   	    |Status of autoscaling  	                                        |true  	       |
|min_replicas   |Minimum number of replicas of the container alive at a given time  |2   	       |
|max_replicas   |Maximum number of replicas of the container alive at a given time  |3   	       |
|cpu   	        |CPU Utilization threshold for spawning a new instance 	            |50   	       |
|memory   	    |Memory Utilization threshold for for spawning a new instance 	    |80   	       |

#### [cloud.deployment.probes.readiness]

Probe to indicate whether the container is ready to respond to requests. No readiness probe will be generated if not
 specified.
 
|Identifier |Description	                        |Example Value  |
|---	    |---	                                |---	        |
|port   	|Port of the Readiness probe endpoint   |9091  	        |
|path   	|Endpoint of the Readiness probe   	    |"/readyz"   	|
  

#### [cloud.deployment.probes.liveness]

Probe to indicate whether the container is running. No liveness probe will be generated if not specified.

|Identifier |Description	                      |Example Value   	|
|---	    |---	                              |---	            |
|port   	|Port of the Liveness probe endpoint  |9091  	        |
|path   	|Endpoint of the Liveness probe   	  |"/healthz"   	|

#### [[cloud.deployment.storage.volumes]]

Contains the volume definitions of the application. No default volumes will be generated if not specified.

|Identifier  |Description	             |Example Value |
|---	     |---	                     |---	        |
|name   	 |Name of the volume  	     |"volume1"  	|
|local_path  |Path of the volume   	     |"files"   	|
|size   	 |Maximum size of the Volume |"2Gi"   	    |
